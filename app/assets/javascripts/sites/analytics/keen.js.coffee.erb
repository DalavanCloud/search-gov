loadKeen = `function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://":"http://")+"dc8na2hxrj29i.cloudfront.net/code/keen-2.1.0-min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}`

initializeKeen = () ->
  window.Keen ?= `{configure:function(e){this._cf=e},addEvent:function(e,t,n,i){this._eq=this._eq||[],this._eq.push([e,t,n,i])},setGlobalProperties:function(e){this._gp=e},onChartsReady:function(e){this._ocrq=this._ocrq||[],this._ocrq.push(e)}};`
  loadKeen()

configureKeen = (canvas) ->
  key = $(canvas).data 'key'
  Keen.configure
    projectId: "<%= Keen.project_id %>",
    readKey: key

queriesPieReady = (canvas) ->
  $canvas = $(canvas)
  module = $canvas.data 'module'
  modelId = $canvas.data 'modelId'

  queriesMetric = new Keen.Metric "impressions",
    analysisType: "count",
    groupBy: "query",
    timeframe: "this_month",
    filters: [
      {"property_name":"module","operator":"eq","property_value":module},
      {"property_name":"model_id","operator":"eq","property_value":modelId}
    ]
  queriesPie = new Keen.PieChart queriesMetric,
    title: "Top queries leading here"
  queriesPie.draw canvas

ready = () ->
  $('#keen-queries-pie').each () ->
    initializeKeen() if !window.Keen?
    configureKeen @

    canvas = @
    Keen.onChartsReady (obj) -> queriesPieReady canvas

$(document).ready ready
$(document).on 'page:load', ready

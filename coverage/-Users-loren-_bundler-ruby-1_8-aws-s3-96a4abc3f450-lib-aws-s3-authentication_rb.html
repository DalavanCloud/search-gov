<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>/Users/loren/.bundler/ruby/1.8/aws-s3-96a4abc3f450/lib/aws/s3/authentication.rb</title>
    <link href="screen.css" media="all" rel="stylesheet" type="text/css" />
    <link href="print.css" media="print" rel="stylesheet" type="text/css" />
    
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src="rcov.js"></script>
  </head>
  <body>
    <h1>Usasearch C0 Coverage Information - RCov</h1>
    <h2>/Users/loren/.bundler/ruby/1.8/aws-s3-96a4abc3f450/lib/aws/s3/authentication.rb</h2>

    

    <div class="report_table_wrapper">
      <table class='report' id='report_table'>
        <thead>
          <tr>
            <th class="left_align">Name</th>
            <th class="right_align">Total Lines</th>
            <th class="right_align">Lines of Code</th>
            <th class="left_align">Total Coverage</th>
            <th class="left_align">Code Coverage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="left_align"><a href="-Users-loren-_bundler-ruby-1_8-aws-s3-96a4abc3f450-lib-aws-s3-authentication_rb.html">/Users/loren/.bundler/ruby/1.8/aws-s3-96a4abc3f450/lib/aws/s3/authentication.rb</a></td>
            <td class='right_align'><tt>221</tt></td>
            <td class='right_align'><tt>128</tt></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>100.00%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:100px"></div>
            <div class="uncovered" style="width:0px"></div>
          </div></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>100.00%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:100px"></div>
            <div class="uncovered" style="width:0px"></div>
          </div></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <h3>Key</h3>
    
    <div class="key"><pre><span class='marked'>Code reported as executed by Ruby looks like this...</span><span class='marked1'>and this: this line is also marked as covered.</span><span class='inferred'>Lines considered as run by rcov, but not reported by Ruby, look like this,</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).</span><span class='uncovered'>Finally, here's a line marked as not executed.</span></pre></div>

    <h3>Coverage Details</h3>

    <table class="details">
      <tbody>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1">1</a> module AWS</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line2">2</a>   module S3    </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line3">3</a>     # All authentication is taken care of for you by the AWS::S3 library. None the less, some details of the two types</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line4">4</a>     # of authentication and when they are used may be of interest to some.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line5">5</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line6">6</a>     # === Header based authentication</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line7">7</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line8">8</a>     # Header based authentication is achieved by setting a special &lt;tt&gt;Authorization&lt;/tt&gt; header whose value </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line9">9</a>     # is formatted like so:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line10">10</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line11">11</a>     #   &quot;AWS #{access_key_id}:#{encoded_canonical}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line12">12</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line13">13</a>     # The &lt;tt&gt;access_key_id&lt;/tt&gt; is the public key that is assigned by Amazon for a given account which you use when</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line14">14</a>     # establishing your initial connection. The &lt;tt&gt;encoded_canonical&lt;/tt&gt; is computed according to rules layed out </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line15">15</a>     # by Amazon which we will describe presently.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line16">16</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line17">17</a>     # ==== Generating the encoded canonical string</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line18">18</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line19">19</a>     # The &quot;canonical string&quot;, generated by the CanonicalString class, is computed by collecting the current request method, </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line20">20</a>     # a set of significant headers of the current request, and the current request path into a string. </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line21">21</a>     # That canonical string is then encrypted with the &lt;tt&gt;secret_access_key&lt;/tt&gt; assigned by Amazon. The resulting encrypted canonical </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line22">22</a>     # string is then base 64 encoded.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line23">23</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line24">24</a>     # === Query string based authentication</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line25">25</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line26">26</a>     # When accessing a restricted object from the browser, you can authenticate via the query string, by setting the following parameters:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line27">27</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line28">28</a>     #   &quot;AWSAccessKeyId=#{access_key_id}&amp;Expires=#{expires}&amp;Signature=#{encoded_canonical}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line29">29</a>     # </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line30">30</a>     # The QueryString class is responsible for generating the appropriate parameters for authentication via the</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line31">31</a>     # query string.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line32">32</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line33">33</a>     # The &lt;tt&gt;access_key_id&lt;/tt&gt; and &lt;tt&gt;encoded_canonical&lt;/tt&gt; are the same as described in the Header based authentication section. </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line34">34</a>     # The &lt;tt&gt;expires&lt;/tt&gt; value dictates for how long the current url is valid (by default, it will expire in 5 minutes). Expiration can be specified</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line35">35</a>     # either by an absolute time (expressed in seconds since the epoch), or in relative time (in number of seconds from now).</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line36">36</a>     # Details of how to customize the expiration of the url are provided in the documentation for the QueryString class.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line37">37</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line38">38</a>     # All requests made by this library use header authentication. When a query string authenticated url is needed, </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line39">39</a>     # the S3Object#url method will include the appropriate query string parameters.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line40">40</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line41">41</a>     # === Full authentication specification</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line42">42</a>     #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line43">43</a>     # The full specification of the authentication protocol can be found at</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line44">44</a>     # http://docs.amazonwebservices.com/AmazonS3/2006-03-01/RESTAuthentication.html    </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line45">45</a>     class Authentication</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line46">46</a>       constant :AMAZON_HEADER_PREFIX, 'x-amz-'</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line47">47</a>       </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line48">48</a>       # Signature is the abstract super class for the Header and QueryString authentication methods. It does the job</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line49">49</a>       # of computing the canonical_string using the CanonicalString class as well as encoding the canonical string. The subclasses</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line50">50</a>       # parameterize these computations and arrange them in a string form appropriate to how they are used, in one case a http request</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line51">51</a>       # header value, and in the other case key/value query string parameter pairs.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line52">52</a>       class Signature &lt; String #:nodoc:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line53">53</a>         attr_reader :request, :access_key_id, :secret_access_key, :options</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line54">54</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line55">55</a>         def initialize(request, access_key_id, secret_access_key, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line56">56</a>           super()</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line57">57</a>           @request, @access_key_id, @secret_access_key = request, access_key_id, secret_access_key</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line58">58</a>           @options = options</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line59">59</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line60">60</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line61">61</a>         private</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line62">62</a>     </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line63">63</a>           def canonical_string            </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line64">64</a>             options = {}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line65">65</a>             options[:expires] = expires if expires?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line66">66</a>             CanonicalString.new(request, options)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line67">67</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line68">68</a>           memoized :canonical_string</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line69">69</a>     </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line70">70</a>           def encoded_canonical</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line71">71</a>             digest   = OpenSSL::Digest::Digest.new('sha1')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line72">72</a>             b64_hmac = [OpenSSL::HMAC.digest(digest, secret_access_key, canonical_string)].pack(&quot;m&quot;).strip</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line73">73</a>             url_encode? ? CGI.escape(b64_hmac) : b64_hmac</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line74">74</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line75">75</a>           </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line76">76</a>           def url_encode?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line77">77</a>             !@options[:url_encode].nil?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line78">78</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line79">79</a>           </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line80">80</a>           def expires?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line81">81</a>             is_a? QueryString</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line82">82</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line83">83</a>           </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line84">84</a>           def date</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line85">85</a>             request['date'].to_s.strip.empty? ? Time.now : Time.parse(request['date'])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line86">86</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line87">87</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line88">88</a>       </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line89">89</a>       # Provides header authentication by computing the value of the Authorization header. More details about the</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line90">90</a>       # various authentication schemes can be found in the docs for its containing module, Authentication.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line91">91</a>       class Header &lt; Signature #:nodoc:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line92">92</a>         def initialize(*args)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line93">93</a>           super</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line94">94</a>           self &lt;&lt; &quot;AWS #{access_key_id}:#{encoded_canonical}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line95">95</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line96">96</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line97">97</a>       </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line98">98</a>       # Provides query string authentication by computing the three authorization parameters: AWSAccessKeyId, Expires and Signature.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line99">99</a>       # More details about the various authentication schemes can be found in the docs for its containing module, Authentication.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line100">100</a>       class QueryString &lt; Signature #:nodoc:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line101">101</a>         constant :DEFAULT_EXPIRY, 300 # 5 minutes</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line102">102</a>         def initialize(*args)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line103">103</a>           super</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line104">104</a>           options[:url_encode] = true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line105">105</a>           self &lt;&lt; build</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line106">106</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line107">107</a>         </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line108">108</a>         private</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line109">109</a>           </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line110">110</a>           # Will return one of three values, in the following order of precedence:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line111">111</a>           #</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line112">112</a>           #   1) Seconds since the epoch explicitly passed in the +:expires+ option</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line113">113</a>           #   2) The current time in seconds since the epoch plus the number of seconds passed in</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line114">114</a>           #      the +:expires_in+ option</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line115">115</a>           #   3) The current time in seconds since the epoch plus the default number of seconds (60 seconds)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line116">116</a>           def expires</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line117">117</a>             return options[:expires] if options[:expires]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line118">118</a>             date.to_i + expires_in</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line119">119</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line120">120</a>           </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line121">121</a>           def expires_in</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line122">122</a>             options.has_key?(:expires_in) ? Integer(options[:expires_in]) : DEFAULT_EXPIRY</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line123">123</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line124">124</a>           </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line125">125</a>           # Keep in alphabetical order</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line126">126</a>           def build</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line127">127</a>             &quot;AWSAccessKeyId=#{access_key_id}&amp;Expires=#{expires}&amp;Signature=#{encoded_canonical}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line128">128</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line129">129</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line130">130</a>       </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line131">131</a>       # The CanonicalString is used to generate an encrypted signature, signed with your secrect access key. It is composed of </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line132">132</a>       # data related to the given request for which it provides authentication. This data includes the request method, request headers,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line133">133</a>       # and the request path. Both Header and QueryString use it to generate their signature.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line134">134</a>       class CanonicalString &lt; String #:nodoc:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line135">135</a>         class &lt;&lt; self</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line136">136</a>           def default_headers</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line137">137</a>             %w(content-type content-md5)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line138">138</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line139">139</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line140">140</a>           def interesting_headers</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line141">141</a>             ['content-md5', 'content-type', 'date', amazon_header_prefix]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line142">142</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line143">143</a>           </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line144">144</a>           def amazon_header_prefix</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line145">145</a>             /^#{AMAZON_HEADER_PREFIX}/io</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line146">146</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line147">147</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line148">148</a>         </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line149">149</a>         attr_reader :request, :headers</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line150">150</a>         </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line151">151</a>         def initialize(request, options = {})</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line152">152</a>           super()</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line153">153</a>           @request = request</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line154">154</a>           @headers = {}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line155">155</a>           @options = options</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line156">156</a>           # &quot;For non-authenticated or anonymous requests. A NotImplemented error result code will be returned if </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line157">157</a>           # an authenticated (signed) request specifies a Host: header other than 's3.amazonaws.com'&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line158">158</a>           # (from http://docs.amazonwebservices.com/AmazonS3/2006-03-01/VirtualHosting.html)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line159">159</a>           request['Host'] = DEFAULT_HOST</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line160">160</a>           build</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line161">161</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line162">162</a>     </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line163">163</a>         private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line164">164</a>           def build</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line165">165</a>             self &lt;&lt; &quot;#{request.method}\n&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line166">166</a>             ensure_date_is_valid</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line167">167</a>             </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line168">168</a>             initialize_headers</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line169">169</a>             set_expiry!</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line170">170</a>         </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line171">171</a>             headers.sort_by {|k, _| k}.each do |key, value|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line172">172</a>               value = value.to_s.strip</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line173">173</a>               self &lt;&lt; (key =~ self.class.amazon_header_prefix ? &quot;#{key}:#{value}&quot; : value)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line174">174</a>               self &lt;&lt; &quot;\n&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line175">175</a>             end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line176">176</a>             self &lt;&lt; path</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line177">177</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line178">178</a>       </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line179">179</a>           def initialize_headers</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line180">180</a>             identify_interesting_headers</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line181">181</a>             set_default_headers</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line182">182</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line183">183</a>           </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line184">184</a>           def set_expiry!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line185">185</a>             self.headers['date'] = @options[:expires] if @options[:expires]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line186">186</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line187">187</a>           </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line188">188</a>           def ensure_date_is_valid</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line189">189</a>             request['Date'] ||= Time.now.httpdate</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line190">190</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line191">191</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line192">192</a>           def identify_interesting_headers</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line193">193</a>             request.each do |key, value|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line194">194</a>               key = key.downcase # Can't modify frozen string so no bang</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line195">195</a>               if self.class.interesting_headers.any? {|header| header === key}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line196">196</a>                 self.headers[key] = value.to_s.strip</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line197">197</a>               end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line198">198</a>             end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line199">199</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line200">200</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line201">201</a>           def set_default_headers</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line202">202</a>             self.class.default_headers.each do |header|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line203">203</a>               self.headers[header] ||= ''</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line204">204</a>             end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line205">205</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line206">206</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line207">207</a>           def path</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line208">208</a>             [only_path, extract_significant_parameter].compact.join('?')</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line209">209</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line210">210</a>           </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line211">211</a>           def extract_significant_parameter</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line212">212</a>             request.path[/[&amp;?](acl|torrent|logging)(?:&amp;|=|$)/, 1]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line213">213</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line214">214</a>           </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line215">215</a>           def only_path</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line216">216</a>             request.path[/^[^?]*/]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line217">217</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line218">218</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line219">219</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line220">220</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line221">221</a> end</pre></td>
          </tr>
        
      </tbody>
    </table>

    <p>Generated on Mon May 23 20:35:53 -0700 2011 with <a href="http://github.com/relevance/rcov">rcov 0.9.8</a></p>

  </body>
</html>

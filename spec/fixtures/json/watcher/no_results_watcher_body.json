{
  "trigger": {
    "schedule": {
      "interval": "1m"
    }
  },
  "input": {
    "search": {
      "request": {
        "search_type": "count",
        "types": [
          "search"
        ],
        "indices": [
          "<human-logstash-{now/d}>",
          "<human-logstash-{now/d-1d}>",
          "<human-logstash-{now/d-2d}>",
          "<human-logstash-{now/d-3d}>",
          "<human-logstash-{now/d-4d}>",
          "<human-logstash-{now/d-5d}>",
          "<human-logstash-{now/d-6d}>",
          "<human-logstash-{now/d-7d}>",
          "<human-logstash-{now/d-8d}>"
        ],
        "body": {
          "query": {
            "filtered": {
              "filter": {
                "bool": {
                  "must": [
                    {
                      "term": {
                        "affiliate": "nps.gov"
                      }
                    },
                    {
                      "missing": {
                        "field": "modules"
                      }
                    },
                    {
                      "range": {
                        "@timestamp": {
                          "gte": "{{ctx.trigger.scheduled_time}}||-1w",
                          "lte": "{{ctx.trigger.scheduled_time}}"
                        }
                      }
                    }
                  ],
                  "must_not": [
                    {
                      "term": {
                        "useragent.device": "Spider"
                      }
                    },
                    {
                      "term": {
                        "raw": ""
                      }
                    },
                    {
                      "terms": {
                        "raw": [
                          "foo",
                          "bar",
                          "another one"
                        ]
                      }
                    }
                  ]
                }
              }
            }
          },
          "aggs": {
            "agg": {
              "terms": {
                "min_doc_count": 34,
                "size": 10,
                "field": "raw"
              }
            }
          }
        }
      }
    }
  },
  "condition": {
    "script": "ctx.payload.aggregations && ctx.payload.aggregations.agg.buckets.size() > 0"
  },
  "throttle_period": "24h",
  "transform": {
    "script": "ctx.payload.aggregations.agg.buckets.collect({ it.key }).join('\",\"')"
  },
  "actions": {
    "analytics_alert": {
      "webhook": {
        "method": "POST",
        "scheme": "https",
        "host": "mandrillapp.com",
        "port": 443,
        "path": "/api/1.0/messages/send-template.json",
        "headers": {
          "Content-type": "application/json"
        },
        "body": "{\"key\":null,\"template_name\":\"no-results-watcher\",\"template_content\":[],\"message\":{\"from_email\":\"no-reply@support.digitalgov.gov\",\"from_name\":\"DigitalGov Search Team\",\"merge_language\":\"handlebars\",\"track_opens\":false,\"inline_css\":true,\"to\":[{\"email\":\"affiliate_manager@fixtures.org\",\"name\":\"Affiliate Manager\"}],\"global_merge_vars\":[{\"name\":\"alert_name\",\"content\":\"no rez\"},{\"name\":\"site_name\",\"content\":\"nps.gov\"},{\"name\":\"site_id\",\"content\":539378566},{\"name\":\"site_homepage_url\",\"content\":\"http://www.nps.gov\"},{\"name\":\"contact_name\",\"content\":\"Affiliate Manager\"},{\"name\":\"user_id\",\"content\":667152013},{\"name\":\"query_terms\",\"content\":[\"{{ctx.payload._value}}\"]}]}}"
      }
    }
  },
  "metadata": {
    "affiliate": "nps.gov",
    "affiliate_id": 539378566,
    "user_email": "affiliate_manager@fixtures.org",
    "user_id": 667152013,
    "user_contact_name": "Affiliate Manager",
    "watcher_type": "NoResultsWatcher"
  }
}